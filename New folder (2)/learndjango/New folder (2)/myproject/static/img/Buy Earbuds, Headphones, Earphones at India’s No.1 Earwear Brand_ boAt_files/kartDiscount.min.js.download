
window.KDHooks = window.KDHooks || {};
let kartHtml = '';
window.KDHooks.__handleHTMLCreations_af = function (htmlElem, cartSelectorObj) {
  // updating html of discount field
  return kartHtml;
}

window.KDHooks.__postDiscountProcess_af = function (response) {
  // Updating html of discount field on the basis of applied discount and updating responce of kart discount api for discount capping.
  var responseData = '';
  if (typeof response === 'string') {
    responseData = JSON.parse(response);
  }
  else {
    responseData = response;
  }
  if (responseData.is_success) {
    // console.log('responseData', responseData);
    var total_discount_amount = sessionStorage.total_discount_amount;
    total_discount_amount = parseInt(total_discount_amount);
    var cart_amount = responseData.data.response.formatted_text.total_price;
    var discount_amount = responseData.data.response.formatted_text.discount_amount;
    var saveAmount = parseFloat(discount_amount);
    var discount_pair = responseData.data.response.formatted_text.discount_pair;
    var discount_code = Object.keys(discount_pair);
    if (total_discount_amount > 0 && total_discount_amount < discount_amount && sessionStorage.offer_discount_code == discount_code[0]) {
      var after_discount = cart_amount - total_discount_amount;
      saveAmount = total_discount_amount;
      responseData.data.response.formatted_text.discount_amount = total_discount_amount.toFixed(2);
      responseData.data.response.formatted_text.final_total_price = after_discount.toFixed(2);
    }
    $('#discount__amount').text(saveAmount)
    $('#pay__amount').text(responseData.data.response.formatted_text.final_total_price)
    $('.pay__total').removeClass('visually-hidden')
    $('.mc_pay__total').addClass('visually-hidden')
    $('.discount__total').removeClass('visually-hidden')
    if(Shopify.redeem_points) {
      init_nector_discount_preview(responseData.data.response.formatted_text.final_total_price * 100);
    } else {
      if($('.signin_redeem.redeem_points').length) {
        $('.redeem_now').addClass('visually-hidden')
        $('.get_points').removeClass('visually-hidden')
        $('.custom-checkbox').prop('checked', false)
        const earnablePoints = Math.floor(responseData.data.response.formatted_text.final_total_price * 0.05);
        $('.earnable_points').text(earnablePoints)
        redeemLoyaltyPoints()
      }
    }

    var KartDiscount_detail = JSON.parse(Shopify.KartDiscount_detail);
    if(KartDiscount_detail[discount_code[0]] != undefined) {
      sessionStorage.setItem('applyCoupun_heading', KartDiscount_detail[discount_code[0]]);
    }

    sessionStorage.setItem('applyCoupun', discount_code[0]);
    sessionStorage.setItem('Coupun_saveAmount', saveAmount);
    $('.af_coupon_text').html(discount_code[0]);
    $('.afHiddenDiscount').val(discount_code[0]);
    $('#af_custom_coupon_text').val(discount_code[0]);
    $('.discountCode_details').html(`₹${saveAmount} savings with this coupon`);
    $('.custom_kartdiscount_container').addClass('discount_applied');
    $('.custom_kartdiscount_container').addClass('discount_added');
    $('.discountCode_details_container').addClass('show');
    $('.custom_kartdiscount_container .af_btn_holder').html(`<button type="button" class="discountCode__remove_btn" onclick="CDSetupInit.removeIndividualCoupon('${discount_code[0]}',this);">Remove</button>`);
    $('.custom_kartdiscount_container').attr('couponCode', 'true');
    $('.mini-cart-total-price').hide();
    $('.discount_error').html('');
    let cart_json = responseData.data.cart_json;
    cart_json = JSON.parse(cart_json);
      var cartTotal = cart_json.total_price;
      var line_item = document.querySelectorAll('line-item');
        for (var i = 0; i < cart_json.items.length; i++) {
          var itemPrice = cart_json.items[i].line_price;
          var discountPercent =itemPrice / cartTotal;
          discountPercent = Math.round(discountPercent * 100);
          var itemDiscount = saveAmount * discountPercent;
          var finalItemPrice = itemPrice - itemDiscount;
          finalItemPrice = Shopify.formatMoney(finalItemPrice, Shopify.money_format2);
          line_item[i] ? line_item[i].querySelector('.price-list') ? line_item[i].querySelector('.price-list').classList.add('kartDiscount_applied') : '' : '';
          line_item[i] ? line_item[i].querySelector('.discount_line_price') ? line_item[i].querySelector('.discount_line_price').innerHTML = finalItemPrice : '' : '';
        }

  } else if (responseData.is_success == false && responseData.code == "516") {
    var discountCode = responseData.data.discount_code;
    KDSdk.showError('Coupon code ' + discountCode + ' is invalid. Please try another code')
  }
  else {
    $('.discount_error').html(responseData.message);
    $('#af_custom_coupon_text').click(function () {
      $(this).val('');
      $('.discount_error').html('');
    });
    setTimeout(function () {
      $('.discount_error').html('');
    }, 7000);
  }
  responseData = JSON.stringify(responseData);
  response = responseData;
  // response.data.entire_response = responseData;
  return response; // return the modified response back.
}

function deleteCookie(cookieName) {
  document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
}

var kdDom = document.querySelector('body');
kdDom.addEventListener('KD_discountRemoved', (e) => {
  // here we are updating the content of discount field in cart drawer on removal of discount code.
  // $('.custom_kartdiscount_container .af_btn_holder').html(`<button type="button" class="af_custom_apply_coupon_trigger btn btn--regular btn--color btn--fill tlblbr0" id="af_custom_apply_coupon_trigger" onclick="Shopify.DiscountSubmit()" style="margin:0;width:100%;max-height:42px;min-height:42px;padding: 8px 31px;">
  //   <af class="af_after_loading">Apply</af>
  // </button>`);
  $('.custom_kartdiscount_container').removeAttr('couponCode');
  $('.mini-cart-total-price').show();
  $('.mc_pay__total').removeClass('visually-hidden');
  $('.pay__total').addClass('visually-hidden');
  $('.discount__total').addClass('visually-hidden')
  $('.discount_finder_item_cta_btn button').html('<span>Tap To Apply</span>');
  $('.discount_finder_item_cta_btn button').removeClass('coupon_applied');
  $('.custom_kartdiscount_container').removeClass('discount_applied');
  $('#af_custom_coupon_text').val(sessionStorage.applyCoupun);
  $('.discountCode .af_coupon_code').html(sessionStorage.applyCoupun);
  $('.discountCode_details').html(sessionStorage.getItem('applyCoupun_heading'));
  var line_item = document.querySelectorAll('line-item');
  for (var i = 0; i < line_item.length; i++) {
    line_item[i].querySelector('.price-list') ? line_item[i].querySelector('.price-list').classList.remove('kartDiscount_applied') : '';
    line_item[i].querySelector('.discount_line_price') ? line_item[i].querySelector('.discount_line_price').innerHTML = '' : '';
  }
  var cartTotal = parseInt($('.total-price').text().replace('₹', '').replace(',', ''))
  if(Shopify.redeem_points){
    init_nector_discount_preview(cartTotal * 100);
  } else {
    if($('.signin_redeem.redeem_points').length) {
      $('.redeem_now').addClass('visually-hidden')
      $('.get_points').removeClass('visually-hidden')
      const earnablePoints = Math.floor(cartTotal * 0.05);
      $('.earnable_points').text(earnablePoints)
      $('.custom-checkbox').prop('checked', false)
      redeemLoyaltyPoints()
    }
  }
  setTimeout(() => {
    deleteCookie('discount_code');
  }, 1000)
});
kdDom.addEventListener('KD_validDiscountApplied', (e) => {
  // let discountCode = e.detail;
  var preAppliedCoupon = $('.discount_finder_header_field_details .af_coupon_text.af_coupon_code').html();
  var KartDiscount_detail = JSON.parse(Shopify.KartDiscount_detail);
  if(KartDiscount_detail[preAppliedCoupon] == undefined) {
    sessionStorage.setItem('applyCoupun_heading', '');
  }
  var discount_item = document.querySelectorAll('.discount_finder_item');
  for (var i = 0; i < discount_item.length; i++) {
    discount_item[i].querySelector('.discount_finder_item_cta_btn .discount_cta_btn').classList.contains(preAppliedCoupon) ? [discount_item[i].querySelector('.discount_finder_item_cta_btn .discount_cta_btn').innerHTML = '<span>Applied</span>', discount_item[i].querySelector('.discount_finder_item_cta_btn .discount_cta_btn').classList.add('coupon_applied'), discount_item[i].classList.add('applied_discount')]: [discount_item[i].querySelector('.discount_finder_item_cta_btn .discount_cta_btn').innerHTML = '<span>Tap To Apply</span>', discount_item[i].querySelector('.discount_finder_item_cta_btn .discount_cta_btn').classList.remove('coupon_applied'), discount_item[i].classList.remove('applied_discount') ];
  }

  // $('.discount_finder_item_cta_btn .' + preAppliedCoupon).html('<span>Applied</span>');
  // $('.discount_finder_item_cta_btn .' + preAppliedCoupon).addClass('coupon_applied');
   $('.custom_discount_filder_container').removeAttr('open_finder');
});

Shopify.farziDiscount = function (basecode, cartToken) {
  $.ajax({
      type: "POST", 
      url: "https://farzipromoshopify.farziengineer.co/discount", 
      headers: { 
        "Content-Type": "application/json",
        'Cookie': 'csrftoken=GQWoN0lQFCINL2FYU7oLkdE9ohjwfv46'
      },
      data: `{"code":"${basecode}", "client": "boat", "cartId":"${cartToken}"}`,
  }).then((response) => {
    // console.log(response , 'sucess response');
      if (response == "true" || response == "True") {
          setTimeout(function () {
      var couponlog_postrequest = {
          url: "https://boat-api.farziengineer.co/couponlog",
          method: "POST", timeout: 0,
          headers: { "Content-Type": "application/json", },
      };
      var v = setInterval(function () {
          if ($(".edit_checkout .fieldset:last p").length != 0 && $(".edit_checkout .fieldset:last p").css("display") != "none") {
              couponlog_postrequest.data = JSON.stringify({
                  coupon: basecode,
                  log: $(".edit_checkout .fieldset:last p").text(),
              });
              $.ajax(couponlog_postrequest).done(function (response) { });
              clearInterval(v);
          } else if ($(".notice.notice--warning .notice__content .notice__text").text().length > 0) {
              couponlog_postrequest.data = JSON.stringify({ coupon: basecode, log: $(".notice.notice--warning .notice__content .notice__text").text(), });
              $.ajax(couponlog_postrequest).done(function (response) { });
              clearInterval(v);
          } else if ($(".tags-list .tag .tag__wrapper .reduction-code .reduction-code__text").length != 0) {
              couponlog_postrequest.data = JSON.stringify({ coupon: basecode, log: $(".tags-list .tag .tag__wrapper .reduction-code .reduction-code__text").text(), });
              $.ajax(couponlog_postrequest).done(function (response) { });
              clearInterval(v);
          }
      }, 1000);
  }, 3000);
      }
  }).fail((response) => {
    // console.log(response , 'fail response');
});
}

Shopify.DiscountSubmit = function () {
// here we are farzi discount api on kart discount field submit
let coupon = $('#af_kd_custom_coupon_text').val() != '' ? $('#af_kd_custom_coupon_text').val() : $('.discountCode .af_coupon_code').html();
  if($('#af_kd_custom_coupon_text').val() != ''){
    $.getJSON('/cart.js', function (cart) {
      var cartToken = cart.token;
       Shopify.farziDiscount(coupon, cartToken);
    })
  }
  
  setTimeout(function () {
    CDSetupInit.applyDiscount(coupon);
    sessionStorage.setItem('applyCoupun',coupon);
    // Old kart discount apply function - CDSetupInit.couponApplyClick(this);
  }, 500);
}

var discount_finder_apply_btn = $('.discount_finder_btn_holder .discount_finder_apply_btn');
$('#af_kd_custom_coupon_text').on('input', function() {
  $(this).val().length > 0 ? discount_finder_apply_btn.addClass('discount_finder_active_btn') : discount_finder_apply_btn.removeClass('discount_finder_active_btn');
});

window.KDHooks.__numberToMoney_af = function (convertedMoneyStr, extras) {
// converted currency string from number
  var finalAmount = extras.finalAmount;
  finalAmount = finalAmount.replace('.00', '');
  extras.money_format_first = "₹";
  convertedMoneyStr = extras.money_format_first + finalAmount + extras.money_format_second;
  return convertedMoneyStr; // $1.000,00 | {money_format_first: "$", finalAmount: '1.000,00', money_format_second: '', unconvertedString: '100000'}
}   

// BulkCoupon Solution API
Shopify.BulkCouponAPI = function (couponcode) {
  const bulkCouponURL = "https://bulkcoupon.boat-lifestyle.com/api/createcoupononshopify";
  const data = {"coupon": couponcode}

  fetch(bulkCouponURL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(data),
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    return response.json();
  })
  .then(data => {
    //console.log('User Data:', data);
  })
  .catch(error => {
    console.error('Error:', error);
  });
}

/* Custom kart code starts */
Shopify.CustomDiscountSubmit = function(requstCouponCode) {
  var customDiscountTextValue = document.querySelector('#custom-discount-text').value;
  var couponCodeValue = customDiscountTextValue ? customDiscountTextValue : requstCouponCode || $('.discountCode .af_coupon_code').html();
  const discountWrapperElement = document.querySelector('.custom-cart-discount-wrapper');
  const discountApplyBtn = document.querySelector('#apply-coupon-btn');
  const afCouponApplyBtn = document.querySelector('#af_custom_apply_coupon_trigger');

  discountApplyBtn.classList.add('btn-loading');
  discountApplyBtn.setAttribute('disabled',true);
  
  if (afCouponApplyBtn) {
    afCouponApplyBtn.classList.add("af_custom_apply_coupon_trigger_loading");
    afCouponApplyBtn.setAttribute('disabled',true);
  } 

  document.querySelector('#custom-discount-text').value = couponCodeValue
 
  if(customDiscountTextValue != '') {
    $.getJSON('/cart.js', function (cart) {
      var cartToken = cart.token;
      Shopify.farziDiscount(couponCodeValue, cartToken);
      Shopify.BulkCouponAPI(couponCodeValue);
    })
  }

  if (couponCodeValue) {
    setTimeout(() => {
      $.getJSON('/cart.js', function(cart) {
        applyDiscount(cart, couponCodeValue);
      })
    }, 1500);
  } else {
    resetFrontendState();
  }

  async function applyDiscount(cart, couponCodeValue) {
    
    const discountAPI = 'https://discounts.boat-lifestyle.com/discount';
    const customerId = parseInt(discountWrapperElement.getAttribute('data-userId'));
    const controller = new AbortController();
    const signal = controller.signal;
    const timeoutDuration = 19000; 

    // Setting timeout
    const timeoutId = setTimeout(() => {
      controller.abort(); 
      throw new Error('Request timed out');
    }, timeoutDuration);

    
    const data = { 
      cart: cart, 
      store: `${Shopify.shop}`, 
      discount: couponCodeValue, 
      customer_id: customerId
    };
  
    try {
      const response = await fetch(discountAPI, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data),
        signal 
      });
  
      if (!response.ok) {
        const error = await response.json();
        throw { status: response.status, message: error.error };
      }

      clearTimeout(timeoutId);
      const res = await response.json();
      const discountCode = res.data.response.formatted_text.discount_pair.discountCode;
      const finalTotalPrice = res.data.response.formatted_text.final_total_price;
      const totalPrice = res.data.response.formatted_text.total_price;
      const discountAmount = res.data.response.formatted_text.discount_amount;
      const discount_code = res.data.response.formatted_text.discount_pair.discountCode;
      const line_level_discount = res.data.response.line_item_discount;
  
      const discountedPrices = document.querySelectorAll('.kart-discounted-price');
      const couponApplyBody = document.querySelector('#after-coupon-apply');
      const discountHiddenInput = document.querySelector('.cart-discount-body input.hiddenDiscountValue');
      const afterCouponResponse = document.querySelector('#after-coupon-response');      
      const couponTag = couponApplyBody.querySelector(".applied-discount-tag");
      const couponCodeText = couponApplyBody.querySelector(".applied-discount-tag span.discount-coupon-code");
      const couponRemoveAttr = couponApplyBody.querySelector(".applied-discount-tag .discount-remove-coupon");
      const afterDiscountValue = afterCouponResponse.querySelector('.applied-coupon-discount span.discount-value');
      const errorMsg = document.querySelector('.custom-cart-discount-wrapper span.error-msg');
      const cartTotalText = document.querySelector('.cart_total_wrapper .cart-total-text');
      const payTotal = document.querySelector('.pay__total');
      const mcPayTotal = document.querySelector('.mc_pay__total');
      const discountTotal = document.querySelector('.discount__total');
      const afCouponText = document.querySelector('.af_coupon_text');
      const afHiddenDiscount = document.querySelector('.afHiddenDiscount');
      const afCustomCouponText = document.querySelector('#af_custom_coupon_text');
      const discountCodeDetails = document.querySelector('.discountCode_details');
      const customkartdiscountContainer = document.querySelector('.custom_kartdiscount_container');
      const discountCodeDetailsContainer = document.querySelector('.discountCode_details_container');
      const KartDiscount_detail = JSON.parse(Shopify.KartDiscount_detail);
      const cartLineProducts = document.querySelectorAll('#mini-cart .line-item');
      const redeemInputCheckbox = document.querySelector(".redeem_points input");
  
      discountWrapperElement.classList.add("discount-applied");
      couponTag.classList.remove("d-none");
      afterCouponResponse.classList.remove("d-none");
      couponApplyBody.querySelector(".applied-discount-tag span.discount-coupon-code").innerText = discountCode;
      afterDiscountValue.innerText = discountAmount;
      couponRemoveAttr.setAttribute('data-applied-coupon', discountCode);
      discountHiddenInput.setAttribute('value', discountCode);
      errorMsg.classList.add('d-none');
      cartTotalText.classList.add('d-none');
      errorMsg.innerHTML = '';
  
      if (discountedPrices.length > 0) {
          discountedPrices.forEach(element => {
              element.remove();
          });
      }
      // alert(Shopify.redeem_points)
      // commented line level discount modification , uncomment to show line level discount breakdown

      /* line-item discount */
      // cartLineProducts?.forEach((product) => {
      //   const getProductId = product.getAttribute('data-item-id');
      //   const hasCoverProduct = product.getAttribute('data-cover-product');
      
      //   if (getProductId && line_level_discount[getProductId]) {
      //     const lineDiscountedPriceValue = line_level_discount[getProductId].discounted_price;
      //     const lineActualPriceValue = line_level_discount[getProductId].discounts[0].price;
      //     const lineDiscountElement = product.querySelector('#discounted-price .line-discounted-price');
      //     const lineActualPriceElement = product.querySelector('#discounted-price .line-actual-price');
      //     const productDiscountContainer = product.querySelector('#discounted-price');
      //     const productPriceContainer = product.querySelector('.actual-price-container');

      //     if (lineDiscountedPriceValue && lineActualPriceValue && lineDiscountedPriceValue > 0) {
            
      //       const compareAtPrice = product.getAttribute('data-compare-price');
      //       if (hasCoverProduct && hasCoverProduct === 'true') {
              
      //         lineDiscountElement.innerHTML = `₹ ${lineDiscountedPriceValue}`;
      //         lineActualPriceElement.innerHTML = `${compareAtPrice}`;
      //       } else {
      //         lineDiscountElement.innerHTML = `₹ ${lineDiscountedPriceValue}`;
      //         lineActualPriceElement.innerHTML = `${compareAtPrice}`;
      //       }

      //       productPriceContainer.classList.add('d-none');
      //       productDiscountContainer.classList.remove('d-none');
      //     }

      //     if (lineDiscountedPriceValue == 0) {
      //       lineDiscountElement.innerHTML = '';
      //       lineActualPriceElement.innerHTML = '';

      //       productPriceContainer.classList.remove('d-none');
      //       productDiscountContainer.classList.add('d-none');
      //     }
      //   }
      // });      
      /* end line-item discount */

      // hardcoding it now for quick fix
      // Shopify.isWalletCheckboxChecked = true ;
      // Shopify.redeem_points == false

      // console.log("vars",Shopify.isWalletCheckboxChecked,Shopify.redeem_points);
      

      if(Shopify.redeem_points && Shopify.isWalletCheckboxChecked == false) {
        // console.log("redeem yes , wallet no");
        
        await init_nector_discount_preview(res.data.response.formatted_text.final_total_price * 100);
        document.querySelector('.nector-total').classList.add('d-none');
        const nectorBalance= document.getElementById('nector-discount-preview').getAttribute("data-nector-balance");
        const nectorDiscountPrice = res.data.response.formatted_text.final_total_price - parseInt(nectorBalance);

        if (res.data.response.formatted_text.final_total_price === 0) {
          var customDiscountPriceElement = $(
            `<small class="strike-through-price kart-discounted-price" data-current-currency="INR" style="text-decoration: line-through;">₹${totalPrice.toFixed(2)}</small>` +
            `<em class="final-price kart-discounted-price"><b>₹${finalTotalPrice.toFixed(2)}</b></em>`
          );
        } else {
          var customDiscountPriceElement = $(
            `<small class="strike-through-price kart-discounted-price" data-current-currency="INR" style="text-decoration: line-through;">${res.data.response.formatted_text.final_total_price.toFixed(2)}</small><em class="final-price kart-discounted-price"><b>${nectorDiscountPrice.toFixed(2)}</b></em>`
          );
        }
        redeemInputCheckbox.checked = true;
        redeemLoyaltyPoints()
      } else if(Shopify.redeem_points === false && Shopify.isWalletCheckboxChecked) {
        // console.log("redeem no , wallet yes");
        
        const userWalletBalance = parseFloat(localStorage.getItem('wallet_available_balance')) || 0 ;
        // await init_nector_discount_preview(res.data.response.formatted_text.final_total_price * 100);
        document.querySelector('.nector-total').classList.add('d-none');
        const nectorBalance = document.getElementById('nector-discount-preview').getAttribute("data-nector-balance") || 0;
        const nectorDiscountPrice = res.data.response.formatted_text.final_total_price -  userWalletBalance;

        var customDiscountPriceElement;
        if(nectorDiscountPrice > 0) {
          customDiscountPriceElement =  $(
            `<small class="strike-through-price kart-discounted-price" data-current-currency="INR" style="text-decoration: line-through;">₹${res.data.response.formatted_text.final_total_price.toFixed(2)}</small><em class="final-price kart-discounted-price"><b>₹${nectorDiscountPrice.toFixed(2)}</b></em>`
          );
        } else {
          customDiscountPriceElement = $(
            `<small class="strike-through-price kart-discounted-price" data-current-currency="INR" style="text-decoration: line-through;">₹${res.data.response.formatted_text.final_total_price.toFixed(2)}</small><em class="final-price kart-discounted-price"><b>₹${0}</b></em>`
          );
        }

      } else if(Shopify.redeem_points && Shopify.isWalletCheckboxChecked) {
        // console.log("reddem yes , wallet yes");
        
        const userWalletBalance = parseFloat(localStorage.getItem('wallet_available_balance')) || 0
        await init_nector_discount_preview(res.data.response.formatted_text.final_total_price * 100);
        document.querySelector('.nector-total').classList.add('d-none');
        const nectorBalance = document.getElementById('nector-discount-preview').getAttribute("data-nector-balance") || 0;
        // console.log({nectorBalance});
        
        const nectorDiscountPrice = res.data.response.formatted_text.final_total_price - (parseInt(nectorBalance) + userWalletBalance);
        // console.log({nectorDiscountPrice});
        

        var customDiscountPriceElement 
        if(nectorDiscountPrice > 0) {
          customDiscountPriceElement = $(
            `<small class="strike-through-price kart-discounted-price" data-current-currency="INR" style="text-decoration: line-through;">₹${res.data.response.formatted_text.final_total_price.toFixed(2)}</small><em class="final-price kart-discounted-price"><b>₹${nectorDiscountPrice.toFixed(2)}</b></em>`
          );
        } else {
          customDiscountPriceElement = $(
            `<small class="strike-through-price kart-discounted-price" data-current-currency="INR" style="text-decoration: line-through;">₹${res.data.response.formatted_text.final_total_price.toFixed(2)}</small><em class="final-price kart-discounted-price"><b>₹${0}</b></em>`
          );
        } 
        redeemInputCheckbox.checked = true;
        redeemLoyaltyPoints()
      }
        else {
          // console.log("all no");
          // document.querySelector('.nector-total').classList.add('d-none');
          if($('.signin_redeem.redeem_points').length) {
            $('.redeem_now').addClass('visually-hidden')
            $('.get_points').removeClass('visually-hidden')
            $('.custom-checkbox').prop('checked', false)
            const earnablePoints = Math.floor(res.data.response.formatted_text.final_total_price * 0.05);
            $('.earnable_points').text(earnablePoints)
            redeemLoyaltyPoints();
          }

        var customDiscountPriceElement = $(
          `<small class="strike-through-price kart-discounted-price" data-current-currency="INR" style="text-decoration: line-through;">₹${totalPrice}</small>` +
          `<em class="final-price kart-discounted-price"><b>₹${finalTotalPrice}</b></em>`
        );
        // $('.nector-total').hide();
        // temporary

        document.querySelector('.nector-total').classList.add('d-none');
      }
  
      $('.cart-total-text').after(customDiscountPriceElement);
  
      /*this below code is used for manage the UI of easy coupon apply box -- [START]*/ 
      document.querySelector('#discount__amount').textContent = discountAmount;
      document.querySelector('#pay__amount').textContent = res.data.response.formatted_text.final_total_price;
  
      payTotal.classList.remove('visually-hidden');
      discountTotal.classList.remove('visually-hidden');
      mcPayTotal.classList.add('visually-hidden');
  
      if(KartDiscount_detail[discount_code] != undefined) {
        sessionStorage.setItem('applyCoupun_heading', KartDiscount_detail[discount_code]);
      }
  
      sessionStorage.setItem('applyCoupun', discount_code);
      sessionStorage.setItem('Coupun_saveAmount', discountAmount);
  
      afCouponText.innerHTML = discount_code;
      afHiddenDiscount.value = discount_code;
      afCustomCouponText.value = discount_code;
      discountCodeDetails.innerHTML =  `₹${discountAmount} savings with this coupon`;
      customkartdiscountContainer.classList.add('discount_applied');
      customkartdiscountContainer.classList.add('discount_added');
      discountCodeDetailsContainer.classList.add('show');
  
      document.querySelector('.custom_kartdiscount_container .af_btn_holder').innerHTML = `<button type="button" class="discountCode__remove_btn" onclick="Shopify.DiscountRemove('${discount_code}');">Remove</button>`;
      document.querySelector(".custom_kartdiscount_container").setAttribute("couponCode","true");
      /* this below code is used for manage the UI of easy coupon apply box -- [END] */ 
  
      /* this below code is used for manage the UI of tap to apply -- [START] */ 
      let preAppliedCoupon = $('.discount-coupon-text .discount-coupon-code').html();
  
      if(KartDiscount_detail[preAppliedCoupon] == undefined) {
        sessionStorage.setItem('applyCoupun_heading', '');
      }
  
      let discount_item = document.querySelectorAll('.discount_finder_item');
  
      for (var i = 0; i < discount_item.length; i++) {
        if(discount_item[i].querySelector('.discount_finder_item_cta_btn .discount_cta_btn') != null) {
          discount_item[i].querySelector('.discount_finder_item_cta_btn .discount_cta_btn').classList.contains(preAppliedCoupon) ? [discount_item[i].querySelector('.discount_finder_item_cta_btn .discount_cta_btn').innerHTML = '<span>Applied</span>', discount_item[i].querySelector('.discount_finder_item_cta_btn .discount_cta_btn').classList.add('coupon_applied'), discount_item[i].classList.add('applied_discount')]: [discount_item[i].querySelector('.discount_finder_item_cta_btn .discount_cta_btn').innerHTML = '<span>Tap To Apply</span>', discount_item[i].querySelector('.discount_finder_item_cta_btn .discount_cta_btn').classList.remove('coupon_applied'), discount_item[i].classList.remove('applied_discount') ];
        }
      }
  
      document.querySelector('.custom_discount_filder_container').removeAttribute('open_finder')
      /* this below code is used for manage the UI of tap to apply -- [END] */ 

      window.sessionStorage.setItem('custom_coupon-applied', JSON.stringify(res));
      window.sessionStorage.setItem('custom_coupon-code', discountCode);
      document.cookie = "discount_code=" + discountCode + "; expires=Fri, 31 Dec 9999 23:59:59 GMT;path=/";
    } catch (error) {
      clearTimeout(timeoutId);

      if (error.status === 404 || error.status === 403 || error.status === 0) {
        // console.log(error.message);
        handleError(error.message);
      } else {
        console.error('Error:', error);
    
        if (error.message === 'signal is aborted without reason') {
          handleError('Something went wrong, please try again after some time.');
        }
      }
    } finally {
      resetFrontendState();
    }
  }

  // error helper function 
  const handleError = (message) => {
    let errorMsg = document.querySelector('.custom-cart-discount-wrapper span.error-msg');
    let afCartDiscountError = document.querySelector('#af_cart_page .discount_error');

    errorMsg.classList.remove('d-none');
    errorMsg.innerHTML = message;
    afCartDiscountError.innerHTML = message;

    // remove sesstion storage
    window.sessionStorage.removeItem("custom_coupon-code");
    deleteCookie('discount_code');

    setTimeout(() => {
      errorMsg.classList.add('d-none');
      errorMsg.innerHTML = "";
      afCartDiscountError.innerHTML = "";
    }, 3000);
  }
  
  // reset Frontend UI helper function 
  function resetFrontendState() {
    document.querySelector('#custom-discount-text').value = "";
    discountWrapperElement.classList.remove("discount-applied");
    discountApplyBtn.classList.remove('btn-loading');
    discountApplyBtn.removeAttribute('disabled');
    if (afCouponApplyBtn) {
      afCouponApplyBtn.classList.remove("af_custom_apply_coupon_trigger_loading");
      afCouponApplyBtn.removeAttribute('disabled');
    }
  }
}

Shopify.DiscountRemove = async function(discount_code) {
  const hiddenCouponInputVal = document.querySelector('.cart-discount-body input.hiddenDiscountValue');
  const localCouponObject = window.sessionStorage.getItem('custom_coupon-applied');
  let parsedLocalCouponObject = JSON.parse(localCouponObject);
  let finalTotalPrice = parsedLocalCouponObject.data.cart_json.total_price;
  let customDiscountWrapper = document.querySelector('.custom-cart-discount-wrapper');
  let couponApplyBody = document.querySelector('#after-coupon-apply');
  let discountHiddenInput = document.querySelector('.cart-discount-body input.hiddenDiscountValue');
  let afterCouponResponse = document.querySelector('#after-coupon-response');
  let couponTag = couponApplyBody.querySelector(".applied-discount-tag");
  let errorMsg = document.querySelector('.custom-cart-discount-wrapper span.error-msg');
  let successMsg = document.querySelector('.custom-cart-discount-wrapper span.success-msg');

  let couponCodeText = couponApplyBody.querySelector(".applied-discount-tag span.discount-coupon-code");
  let couponRemoveAttr = couponApplyBody.querySelector(".applied-discount-tag .discount-remove-coupon");
  let afterDiscountValue = afterCouponResponse.querySelector('.applied-coupon-discount span.discount-value');
  const cartLineProducts = document.querySelectorAll('#mini-cart .line-item');

  if (customDiscountWrapper.classList.contains('discount-applied')) {
    customDiscountWrapper.classList.remove("discount-applied");
  }

  // commented line level discount modification , uncomment to show line level discount breakdown

  /* line-item discount */
  // cartLineProducts?.forEach((product) => {
  //   const lineDiscountElement = product.querySelector('#discounted-price .line-discounted-price');
  //   const lineActualPriceElement = product.querySelector('#discounted-price .line-actual-price');
  //   const productDiscountContainer = product.querySelector('#discounted-price');
  //   const productPriceContainer = product.querySelector('.actual-price-container');

  //   lineDiscountElement.innerHTML = '';
  //   lineActualPriceElement.innerHTML = '';

  //   productPriceContainer.classList.remove('d-none');
  //   productDiscountContainer.classList.add('d-none');
  // });      
  /* end line-item discount */
  // temporary
  document.querySelector('.nector-total').classList.contains('d-none') ? document.querySelector('.nector-total').classList.remove('d-none') : '';
  
  couponTag.classList.add("d-none");
  afterCouponResponse.classList.add("d-none");
  couponApplyBody.querySelector(".applied-discount-tag span.discount-coupon-code").innerText = '';
  afterDiscountValue.innerText = '';
  couponRemoveAttr.removeAttribute('data-applied-coupon');
  discountHiddenInput.removeAttribute('value');
  
  errorMsg.classList.add('d-none');
  successMsg.classList.add('d-none');
  errorMsg.innerHTML = '';
  successMsg.innerHTML = '';

  let discountedPrices = document.querySelectorAll('.kart-discounted-price');
  discountedPrices.forEach(function(el) {
    el.remove();
  });

  let totalTexts = document.querySelectorAll('.cart_total_wrapper .cart-total-text');
  totalTexts.forEach(function(el) {
    el.classList.remove('d-none');
  });

  document.querySelector('#custom-discount-text').value = '';
  window.sessionStorage.removeItem('custom_coupon-applied');
  window.sessionStorage.removeItem('custom_coupon-code');
  
  document.querySelectorAll('.custom_kartdiscount_container .af_btn_holder').forEach(function(el) {
    el.innerHTML = `<button type="button" class="af_custom_apply_coupon_trigger btn btn--regular btn--color btn--fill tlblbr0" id="af_custom_apply_coupon_trigger" onclick="Shopify.CustomDiscountSubmit()" style="margin:0;width:100%;max-height:42px;min-height:42px;padding: 8px 31px;">
      <af class="af_after_loading">Apply</af>
    </button>`;
  });

  document.querySelectorAll('.mini-cart-total-price').forEach(function(el) {
    el.style.display = 'block';
  });

  document.querySelectorAll('.mc_pay__total').forEach(function(el) {
    el.classList.remove('visually-hidden');
  });

  document.querySelectorAll('.pay__total').forEach(function(el) {
    el.classList.add('visually-hidden');
  });

  document.querySelectorAll('.discount__total').forEach(function(el) {
    el.classList.add('visually-hidden');
  });

  document.querySelectorAll('.custom_kartdiscount_container').forEach(function(el) {
    el.removeAttribute('couponCode');
  });

  document.querySelectorAll('.discount_finder_item_cta_btn button').forEach(function(el) {
    el.innerHTML = '<span>Tap To Apply</span>';
  });

  document.querySelectorAll('.discount_finder_item_cta_btn button').forEach(function(el) {
    el.classList.remove('coupon_applied');
  });

  document.querySelectorAll('.custom_kartdiscount_container').forEach(function(el) {
    el.classList.remove('discount_applied');
  });

  document.querySelector('#af_custom_coupon_text').value = sessionStorage.applyCoupun;
  document.querySelector('.discountCode .af_coupon_code').innerHTML = sessionStorage.applyCoupun;
  document.querySelector('.discountCode_details').innerHTML = sessionStorage.getItem('applyCoupun_heading');

  let cartTotal = parseInt($('.total-price').text().replace('₹', '').replace(',', ''));
  if(Shopify.redeem_points && Shopify.isWalletCheckboxChecked == false){
    await init_nector_discount_preview(cartTotal * 100);
    document.querySelector('.nector-total').classList.remove('d-none');
  }
  else if(Shopify.redeem_points && Shopify.isWalletCheckboxChecked){
    // init_nector_discount_preview(cartTotal * 100);
    // document.querySelector('.nector-total').classList.remove('d-none');
    document.querySelector('.nector-total').classList.remove('d-none');
    Shopify.checkCheckboxStatus()
  } else {
    if($('.signin_redeem.redeem_points').length) {
      $('.redeem_now').addClass('visually-hidden')
      $('.get_points').removeClass('visually-hidden')
      const earnablePoints = Math.floor(cartTotal * 0.05);
      $('.earnable_points').text(earnablePoints)
      $('.custom-checkbox').prop('checked', false)
      redeemLoyaltyPoints()
    }
  }
  
  setTimeout(() => {
    deleteCookie('discount_code');
  }, 1000)
}

class DiscountCodeComponent extends HTMLElement {
  constructor() {
    super();
    this.firstCharacterTyped = false;
  }

  connectedCallback() {
    this.attachEventListeners();
  }

  attachEventListeners() {
    const discountCodeInput = this.querySelector("#custom-discount-text");
    const applyButton = this.querySelector("#apply-coupon-btn");
    const applyButtonBg = this.querySelector('.cart-discount-apply');

    if (discountCodeInput) {
      discountCodeInput.addEventListener('input', (event) => {
        if (!this.firstCharacterTyped && event.target.value.length > 0) {
          applyButton.removeAttribute('disabled');
          applyButtonBg.classList.add("enable");
          this.firstCharacterTyped = true;
        } else if (this.firstCharacterTyped && event.target.value.length === 0) {
          applyButton.setAttribute('disabled', 'true');
          applyButtonBg.classList.remove("enable");
          this.firstCharacterTyped = false;
        }
      });
    }
  }
}

customElements.define('discount-code-component', DiscountCodeComponent);

window.addEventListenerForLoyaltyInput = (event) => {
  const redeemCheckInput = document.querySelector('.redeem_check input');
  const walletCheckInput = document.querySelector('.wallet-custom-checkbox');
  const miniCartGstInput = document.querySelector('.mini-cart__gst input[type=checkbox]');

  // on loyalty points hanldes on kartdiscount add|remove
  if (redeemCheckInput || walletCheckInput || miniCartGstInput) {
    const localCouponData = () => {
        const couponData = window.sessionStorage.getItem('custom_coupon-applied');
        return couponData ? JSON.parse(couponData) : null;
    };

    const nectorBalance = () => {
        const element = document.getElementById('nector-discount-preview');
        return element ? parseInt(element.getAttribute("data-nector-balance")) || 0 : 0;
    };

    const walletBalance = () => parseFloat(localStorage.getItem('wallet_available_balance')) || 0;

    const updateCartPrices = (strikeThroughPrice, finalPrice) => {
        const cartWrapper = document.querySelector('.cart_total_wrapper');
        if (cartWrapper) {
            cartWrapper.querySelector('.strike-through-price').innerHTML = `₹${strikeThroughPrice}`;
            cartWrapper.querySelector('.final-price b').innerHTML = `₹${finalPrice}`;
        }
    };

    const calculatePrices = (redeemChecked, walletChecked, miniGstChecked) => {
        const coupon = localCouponData();
        if (!coupon) return;

        const totalPrice = coupon.data.response.formatted_text.total_price;
        const finalTotalPrice = coupon.data.response.formatted_text.final_total_price;
        const balanceNector = nectorBalance();
        const balanceWallet = walletBalance();

        if (miniGstChecked) {
            updateCartPrices(totalPrice, finalTotalPrice);
        } else if (redeemChecked && walletChecked) {
            const totalDiscountPrice = finalTotalPrice - (balanceNector + balanceWallet);
            totalDiscountPrice > 0 ? updateCartPrices(finalTotalPrice, totalDiscountPrice) : updateCartPrices(finalTotalPrice, 0);
            // updateCartPrices(finalTotalPrice, totalDiscountPrice);
        } else if (redeemChecked) {
            const nectorDiscountPrice = finalTotalPrice - balanceNector;
            updateCartPrices(finalTotalPrice, nectorDiscountPrice);
        } else if (walletChecked) {
            const walletDiscountPrice = finalTotalPrice - balanceWallet;
            walletDiscountPrice > 0 ? updateCartPrices(finalTotalPrice, walletDiscountPrice) : updateCartPrices(finalTotalPrice, 0);
            // updateCartPrices(finalTotalPrice, walletDiscountPrice);
        } else {
            updateCartPrices(totalPrice, finalTotalPrice);
        }
    };

    const handleChange = () => {
        const redeemChecked = redeemCheckInput?.checked || false;
        const walletChecked = walletCheckInput?.checked || false;
        const miniGstChecked = miniCartGstInput?.checked || false;

        calculatePrices(redeemChecked, walletChecked, miniGstChecked);
    };

    // Event listeners
    redeemCheckInput?.addEventListener('change', handleChange);
    walletCheckInput?.addEventListener('change', handleChange);
    miniCartGstInput?.addEventListener('change', handleChange);
  }
}

// on loyalty points hanldes on kartdiscount add|remove
document.addEventListener("DOMContentLoaded", addEventListenerForLoyaltyInput);
