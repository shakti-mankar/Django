(function(){function R(){return window.location.search.includes("jdgm_debug=true")}const b=R();function d(...e){b&&console.log(...e)}window.jdgm=window.jdgm||{},window.jdgm.debugLog=d;async function C(){const e=window.jdgm?.CDN_HOST,t=window.jdgm?.API_HOST;if(!e){d("[Judge.me Widget Loader] CDN_HOST not configured, skipping CDN test");return}const o=`${e}installed.js`;d("[Judge.me Widget Loader] Testing CDN reachability:",o);function c(s){if(d("[Judge.me Widget Loader] ‚ùå CDN test failed, reporting to API"),!t){d("[Judge.me Widget Loader] API_HOST not configured, cannot report CDN failure");return}const i=`${t}api/widget/requests`;fetch(i,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({shop_domain:window.Shopify?.shop,method:"GET",url:o,status:s,duration:0})}).then(()=>{d("[Judge.me Widget Loader] ‚úÖ CDN failure reported to API")}).catch(n=>{d("[Judge.me Widget Loader] ‚ö†Ô∏è Failed to report CDN failure:",n.message)})}const a=document.createElement("script");a.src=o;const r=setTimeout(()=>{c(0)},5e3);a.onload=()=>{clearTimeout(r),d("[Judge.me Widget Loader] ‚úÖ CDN test successful")},a.onerror=()=>{clearTimeout(r),c(-1)},document.head.appendChild(a)}C(),d("[Judge.me Widget Loader] Script loaded and executing...");const L=".jdgm-widget[data-entry-point]",w=document.querySelectorAll(L);if(w.length===0){d("[Judge.me Widget Loader] No containers found with selector:",L);return}d("[Judge.me Widget Loader] Found "+w.length+" container(s), processing each...");const h=new Set,l={REVIEW:"review",ALL_REVIEWS_V2025:"all-reviews-v2025",CAROUSEL:"carousel"},_={review:l.REVIEW,"all-reviews-v2025":l.ALL_REVIEWS_V2025,"testimonials-carousel":l.CAROUSEL,"cards-carousel":l.CAROUSEL};function J(e){const t=e.dataset.widget;return _[t]||null}function D(e){const t=e.querySelector(".jdgm-legacy-widget-content");return t?t.innerHTML.trim().length>20:!1}function I(e,t){if(t===l.ALL_REVIEWS_V2025){const a=window.jdgm?.data?.allReviewsWidgetV2025;return!!(a&&Object.keys(a).length>0)}const o=e.dataset.productId,c=window.jdgm?.data?.reviewWidget?.[o];return!!(c&&c.reviews!==void 0)}function v(e,t,o){const c=window.jdgmSettings?.[t],a=e.dataset.productId,r=D(e),s=I(e,o);let i=null,n="",g="",u=!1;return c?s?(u=!0,r?(i=1,n="Revamp enabled + both data sources available",g="Loading revamp widget (preferred)"):(i=3,n="Revamp enabled + only revamp data",g="Loading revamp widget (only option available)")):r?(i=2,n="Revamp enabled + only legacy data",g="Falling back to legacy widget (revamp data not available)",u=!1):(i="edge-revamp-no-data",n="Revamp enabled + no data sources",g="Loading revamp widget for empty state",u=!0):r?(u=!1,s?(i=4,n="Revamp disabled + both data sources available",g="Showing legacy widget (preferred)"):(i=6,n="Revamp disabled + only legacy data",g="Showing legacy widget (only option available)")):s?(i=5,n="Revamp disabled + only revamp data",g="Falling back to revamp widget (legacy not available)",u=!0):(i="edge-no-data",n="Revamp disabled + no data sources",g="No widget will be shown (no data available)",u=!1),{scenarioId:i,scenarioName:n,decision:g,shouldLoadRevamp:u,metadata:{productId:a,revampEnabled:c,hasLegacyData:r,hasRevampData:s}}}function E(e,t,o,c){d("[Judge.me Widget Loader] "+o+" - Scenario "+t.scenarioId+": "+t.scenarioName),d("[Judge.me Widget Loader] "+o+" - Decision:",t.decision),d("[Judge.me Widget Loader] "+o+" - Debug info:",{...t.metadata,willLoadRevamp:t.shouldLoadRevamp});let a;c===l.ALL_REVIEWS_V2025?a=window.jdgm?.data?.allReviewsWidgetV2025:a=window.jdgm?.data?.reviewWidget?.[t.metadata.productId];const r=!!a;t.metadata.hasRevampData!==r&&(console.warn("[Judge.me Widget Loader] ‚ö†Ô∏è Data mismatch detected!!"),console.warn("[Judge.me Widget Loader] Liquid says hasRevamp:",t.metadata.hasRevampData),console.warn("[Judge.me Widget Loader] JavaScript sees data:",r),console.warn("[Judge.me Widget Loader] Actual data:",a));const s=e.querySelector(".jdgm-legacy-widget-content");if(s){const i=s.innerHTML.trim().length;if(i>0&&i<=20){const n=s.innerHTML.trim().substring(0,50);d("[Judge.me Widget Loader] üìè Legacy widget is small ("+i+' chars), treating as empty. Content: "'+n+'"')}}}function W(e){const t=e.querySelector(".jdgm-legacy-widget-content");t&&(t.style.display=""),d("[Judge.me Widget Loader] ‚úÖ Legacy widget displayed")}function f(e){const t=e.dataset.entryPoint,o=e.dataset.entryKey;if(!t||!o){d("[Judge.me Widget Loader] ‚ö†Ô∏è Missing entryPoint or entryKey, skipping container");return}const c=window.jdgm.CDN_BASE_URL,a=c+t,r=e.querySelector(".jdgm-rev-widg");if(r&&(r.style.display="none",d("[Judge.me Widget Loader] üôà Hidden legacy widget element (.jdgm-rev-widg)")),d("[Judge.me Widget Loader] ‚è≥ Loading revamp widget:",t),h.has(a)||document.querySelector('script[src="'+a+'"]')){d("[Judge.me Widget Loader] ‚è≠Ô∏è Script already loaded, skipping:",t);return}h.add(a),A(c,o,t).finally(()=>{const s=document.createElement("script");s.type="module",s.src=a,s.onload=()=>{d("[Judge.me Widget Loader] ‚úÖ Revamp widget script loaded successfully:",t)},s.onerror=()=>{console.error("[Judge.me Widget Loader] ‚ùå Failed to load revamp widget script:",t)},document.head.appendChild(s)})}async function A(e,t,o){if(!(e+o).includes("localhost"))try{let g=function(u){const m=i[u];m&&(m.css&&m.css.forEach(p=>{const S=e+p;if(!document.querySelector('link[href="'+S+'"]')){const y=document.createElement("link");y.rel="stylesheet",y.href=S,document.head.appendChild(y)}}),m.imports&&m.imports.forEach(g))};var a=g;const r=e+"manifest.json?v="+Date.now(),i=await(await fetch(r)).json(),n=i[t];n&&n.css&&n.css.forEach(u=>{const m=e+u;if(!document.querySelector('link[href="'+m+'"]')){const p=document.createElement("link");p.rel="stylesheet",p.href=m,document.head.appendChild(p)}}),n&&n.imports&&n.imports.forEach(g)}catch(r){console.warn("Could not load manifest or CSS files:",r)}}w.forEach((e,t)=>{const o=J(e),c=e.dataset.entryPoint;if(d("[Judge.me Widget Loader] Processing container "+(t+1)+"/"+w.length+" - Type: "+o+", Entry: "+c),!o){d("[Judge.me Widget Loader] ‚è≠Ô∏è Unknown widget type, skipping container");return}switch(o){case l.REVIEW:{const a=v(e,"review_widget_revamp_enabled",l.REVIEW);E(e,a,"Review Widget",l.REVIEW),a.shouldLoadRevamp?f(e):W(e);break}case l.ALL_REVIEWS_V2025:{const a=v(e,"all_reviews_widget_v2025_enabled",l.ALL_REVIEWS_V2025);E(e,a,"All Reviews V2025 Widget",l.ALL_REVIEWS_V2025),a.shouldLoadRevamp?f(e):W(e);break}case l.CAROUSEL:d("[Judge.me Widget Loader] Carousel widget - always loading revamp"),f(e);break}})})();
