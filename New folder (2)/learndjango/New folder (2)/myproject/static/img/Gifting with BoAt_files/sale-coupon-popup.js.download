(()=>{const STORAGE_KEY="scp_state";if(customElements.get("sale-coupon-popup"))return;class SaleCouponPopup extends HTMLElement{constructor(){super(),this._overlay=null,this._panel=null,this._closeBtn=null,this._copyBtn=null,this._couponEl=null,this._autoHideTimer=null,this._closeDelayOnSwipeOutsideClickSec=null,this._copyResetTimer=null,this._sessionInterval=null,this._isOpen=!1,this._previousActiveElement=null,this._touchStartY=0,this._touchStartX=0,this._clevertapEventName="",this._onOverlayClick=this._onOverlayClick.bind(this),this._onCloseClick=this._onCloseClick.bind(this),this._onCopyClick=this._onCopyClick.bind(this),this._onKeydown=this._onKeydown.bind(this),this._onTransitionEnd=this._onTransitionEnd.bind(this),this._onTouchStart=this._onTouchStart.bind(this),this._onTouchEnd=this._onTouchEnd.bind(this),this._onVariantAdded=this._onVariantAdded.bind(this),this._clevertapEventData={"Customer Name":"NA","Customer Email":"NA","Customer Phone":"NA","Coupon Code":""}}connectedCallback(){this._overlay=this.querySelector(".scp__overlay"),this._swipeIndicator=this.querySelector(".scp__swipe-indicator"),this._panel=this.querySelector(".scp__content-container"),this._closeBtn=this.querySelector(".scp__close-button"),this._copyBtn=this.querySelector(".scp__coupon-code-copy-button"),this._couponEl=this.querySelector(".scp__coupon-code"),!(!this._overlay||!this._panel)&&(this._readDataAttributes(),this._initSessionState(),this._startSessionInterval(),this._overlay.hidden=!0,this._overlay.inert=!0,this._overlay.setAttribute("aria-hidden","true"),this._closeBtn?.addEventListener("click",this._onCloseClick),this._copyBtn?.addEventListener("click",this._onCopyClick),this._panel.addEventListener("transitionend",this._onTransitionEnd),document.removeEventListener("variant:added",this._onVariantAdded),document.addEventListener("variant:added",this._onVariantAdded))}disconnectedCallback(){this._overlay.removeEventListener("click",this._onOverlayClick),this._closeBtn?.removeEventListener("click",this._onCloseClick),this._copyBtn?.removeEventListener("click",this._onCopyClick),this._panel.removeEventListener("transitionend",this._onTransitionEnd),this._panel.removeEventListener("touchstart",this._onTouchStart),this._panel.removeEventListener("touchend",this._onTouchEnd),document.removeEventListener("keydown",this._onKeydown),document.removeEventListener("variant:added",this._onVariantAdded),this._sessionInterval!==null&&(clearInterval(this._sessionInterval),this._sessionInterval=null),this._delayedInteractionListenerTimer&&(clearTimeout(this._delayedInteractionListenerTimer),this._delayedInteractionListenerTimer=null),this._clearPopupTimers()}_onVariantAdded(e){this._sessionInterval!==null&&(this._state.product_added_to_cart=!0,this._persistState(),clearInterval(this._sessionInterval),this._sessionInterval=null)}_readDataAttributes(){const d=this.dataset;this._data={auto_hide:Math.max(0,Number(d.autoHideInSeconds||0)),close_delay_on_swipe_outside_click_sec:Math.max(0,Number(d.closeDelayOnSwipeOutsideClickSec||0)),session_duration:Math.max(1,Number(d.userSessionDurationInSeconds||0)),verify_url:(d.verifyUrl||"").trim(),coupon_code:(d.couponCode||"").trim(),customer_id:(d.customerId||"").trim(),customer_email:(d.customerEmail||"").trim(),customer_name:(d.customerName||"").trim(),customer_phone:(d.customerPhoneNumber||"").trim()},this._clevertapEventName=(d.clevertapEventName||"").trim()}_initSessionState(){const stored=sessionStorage.getItem(STORAGE_KEY);if(stored){this._state=JSON.parse(stored),this._state.last_tick_time=Date.now(),this._persistState(),this._clevertapEventData={"Customer Name":this._state.customer_name,"Customer Email":this._state.customer_email,"Customer Phone":this._state.customer_phone,"Coupon Code":this._state.coupon_code};return}const hasCustomer=!!this._data.customer_id;this._state={total_active_time:0,close_delay_on_swipe_outside_click_sec:this._data.close_delay_on_swipe_outside_click_sec,product_added_to_cart:!1,last_tick_time:Date.now(),sessions_completed:0,current_session:1,popup_shown_count:0,popup_shown_to_customer:!1,copy_click_count:0,close_click_count:0,user_clicked_copy:!1,user_clicked_close:!1,coupon_code:this._data.coupon_code,customer_id:hasCustomer?this._data.customer_id:"NA",customer_email:hasCustomer?this._data.customer_email:"NA",customer_name:hasCustomer?this._data.customer_name:"NA",customer_phone:hasCustomer?this._data.customer_phone:"NA"},this._clevertapEventData={"Customer Name":this._state.customer_name,"Customer Email":this._state.customer_email,"Customer Phone":this._state.customer_phone,"Coupon Code":this._state.coupon_code},this._persistState()}_persistState(){sessionStorage.setItem(STORAGE_KEY,JSON.stringify(this._state))}_startSessionInterval(){this._state.product_added_to_cart||(this._sessionInterval=setInterval(()=>this._tickSessionTime(),1e3))}_tickSessionTime(){const now=Date.now(),delta=Math.floor((now-this._state.last_tick_time)/1e3);delta<=0||(this._state.total_active_time+=delta,this._state.last_tick_time=now,this._state.total_active_time>=this._data.session_duration?(this._state.sessions_completed+=1,this._state.current_session=this._state.sessions_completed+1,this._state.total_active_time=0,this._persistState(),this._handleSessionEntry()):this._persistState())}_handleSessionEntry(){if(this._state.popup_shown_to_customer){this._sessionInterval!==null&&(clearInterval(this._sessionInterval),this._sessionInterval=null);return}if(this._data.coupon_code){if(!this._data.customer_id){this._schedulePopup();return}this._data.verify_url&&this._verifyCustomer()}}async _verifyCustomer(){try{const res=await fetch(this._data.verify_url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({customerId:this._data.customer_id,discountCode:this._data.coupon_code})});if(!res.ok){this._sessionInterval!==null&&(clearInterval(this._sessionInterval),this._sessionInterval=null);return}(await res.json())?.valid===!0&&this._schedulePopup()}catch{}}_schedulePopup(){this._isOpen||this.show()}show(){if(!this._isOpen){if(!this._interactionListenersAttached&&this._data.close_delay_on_swipe_outside_click_sec>=0&&(this._interactionListenersAttached=!0,this._delayedInteractionListenerTimer=setTimeout(()=>{this.isConnected&&(this._overlay.addEventListener("click",this._onOverlayClick),this._panel.addEventListener("touchstart",this._onTouchStart,{passive:!0}),this._panel.addEventListener("touchend",this._onTouchEnd,{passive:!0}),this._swipeIndicator&&!this._swipeIndicator.classList.contains("show-scp-swipe-indicator")&&this._swipeIndicator.classList.add("show-scp-swipe-indicator"))},this._data.close_delay_on_swipe_outside_click_sec*1e3)),this._previousActiveElement=document.activeElement instanceof HTMLElement?document.activeElement:null,this._isOpen=!0,this._state.popup_shown_count+=1,this._state.popup_shown_to_customer=!0,this._persistState(),this._overlay.hidden=!1,this._overlay.inert=!1,requestAnimationFrame(()=>{this._overlay.classList.add("is-open"),this._overlay.removeAttribute("aria-hidden"),this._closeBtn?.focus()}),document.addEventListener("keydown",this._onKeydown),window.clevertap?.event)try{clevertap.event.push("Sale Popup Triggered",this._clevertapEventData)}catch{}this._data.auto_hide>0&&(this._autoHideTimer=setTimeout(()=>this.close(),this._data.auto_hide*1e3))}}close(){if(!this._isOpen)return;this._copyBtn?.classList.contains("is-copied")&&this._copyBtn.classList.remove("is-copied"),this._copyResetTimer&&(clearTimeout(this._copyResetTimer),this._copyResetTimer=null),this._previousActiveElement&&!this.contains(this._previousActiveElement)?this._previousActiveElement.focus():document.body.focus();const scpData=JSON.parse(sessionStorage.getItem(STORAGE_KEY)||"{}");if(window.clevertap?.event)try{clevertap.event.push("Sale Popup Closed",this._clevertapEventData)}catch{}this._state.user_clicked_copy=!1,this._state.user_clicked_close=!1,this._persistState(),this._isOpen=!1,this._clearPopupTimers(),this._overlay.inert=!0,this._overlay.classList.remove("is-open"),requestAnimationFrame(()=>{this._overlay.setAttribute("aria-hidden","true"),this._overlay.hidden=!0}),document.removeEventListener("keydown",this._onKeydown)}_clearPopupTimers(){this._autoHideTimer&&clearTimeout(this._autoHideTimer),this._autoHideTimer=null}_onOverlayClick(e){this._panel.contains(e.target)||this.close()}_onCloseClick(e){e.preventDefault(),this._state.user_clicked_close=!0,this._state.close_click_count+=1,this._persistState(),this.close()}async _onCopyClick(){if(!this._couponEl||!this._copyBtn)return;const clevertapEventData=this._clevertapEventData;try{await navigator.clipboard.writeText(this._couponEl.textContent.trim()),this._state.user_clicked_copy=!0,this._state.copy_click_count+=1,this._persistState(),this._copyBtn.classList.add("is-copied"),this._copyResetTimer=setTimeout(()=>{this._copyBtn.classList.remove("is-copied")},2500),window.clevertap?.event&&clevertap.event.push("Sale Code Copied",clevertapEventData)}catch{}}_onKeydown(e){e.key==="Escape"&&this.close()}_onTransitionEnd(){this._isOpen||(this._overlay.hidden=!0)}_onTouchStart(e){const t=e.touches[0];this._touchStartY=t.clientY,this._touchStartX=t.clientX}_onTouchEnd(e){const t=e.changedTouches[0],deltaY=t.clientY-this._touchStartY,deltaX=Math.abs(t.clientX-this._touchStartX);deltaY>80&&deltaY>deltaX&&this.close()}}customElements.define("sale-coupon-popup",SaleCouponPopup)})();
//# sourceMappingURL=/cdn/shop/t/1004/assets/sale-coupon-popup.js.map?v=14169089965692244371768386345
